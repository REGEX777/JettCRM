<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Expenses | <%= project.name %></title>
  <link rel="stylesheet" href="/css/output.css">
  <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
  <script src="https://kit.fontawesome.com/82eb69e53c.js" crossorigin="anonymous"></script>
</head>

<body class="bg-gray-50">
  <% if (success.length > 0) { %>
  <div class="w-full bg-green-500 text-white py-2 px-4 text-center">
    <p><%= success[0] %></p>
  </div>
  <% } %>

  <% if (error.length > 0) { %>
  <div class="w-full bg-red-500 text-white py-2 px-4 text-center">
    <p><%= error[0] %></p>
  </div>
  <% } %>
  <div class="max-w-4xl mx-auto py-10 px-6">
    <div class="flex justify-between items-center mb-6">
      <a href="/projects/v/<%= project._id %>" class="text-blue-600 text-sm font-medium flex items-center">
        <i class="fas fa-arrow-left mr-2"></i> Back to Project View
      </a>
    </div>

    <div class="mb-6 flex flex-row items-center justify-between">
      <div class="flex flex-col items-start justify-center">
        <h1 class="text-3xl font-bold text-gray-800"><%= project.name %></h1>
        <p class="text-sm text-gray-500 mt-1">Track all project-related expenses</p>
      </div>

      <button id="openBudgetPopup" type="button"
        class="px-5 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">
        <i class="fa-solid fa-rotate-right mr-2"></i> Update Budget
      </button>

    </div>

    <form action="/projects/v/expenses/<%= project._id %>" enctype="multipart/form-data" method="POST"
      class="bg-white rounded-xl p-8 mb-10 shadow-md border border-gray-100">
      <h2 class="text-xl font-semibold text-gray-800 mb-6">Add New Expense</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-1">
          <label class="block text-sm font-medium text-gray-700">Title*</label>
          <input type="text" name="title" required
            class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
            placeholder="Expense title" />
        </div>

        <div class="space-y-1">
          <label class="block text-sm font-medium text-gray-700">Amount ($)*</label>
          <div class="relative">
            <span class="absolute left-3 top-2 text-gray-400">$</span>
            <input type="number" name="amount" required step="0.01"
              class="w-full pl-8 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
              placeholder="0.00" />
          </div>
        </div>

        <div class="space-y-1">
          <label class="block text-sm font-medium text-gray-700">Category*</label>
          <select name="type"
            class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all appearance-none bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiAjdjI4N2ViYyIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLWNoZXZyb24tZG93biI+PHBhdGggZD0ibTYgOSA2IDYgNi02Ii8+PC9zdmc+')] bg-no-repeat bg-[right_0.5rem_center] bg-[length:1.2em]">
            <option value="" disabled selected>Select category</option>
            <option value="Travel">Travel</option>
            <option value="Software">Software</option>
            <option value="Equipment">Equipment</option>
            <option value="Misc">Others</option>
          </select>
        </div>

        <div class="space-y-1">
          <label class="block text-sm font-medium text-gray-700">Upload Invoice (Optional)</label>
          <div class="flex items-center justify-center w-full">
            <label class="flex flex-col w-full cursor-pointer">
              <div
                class="flex flex-col items-center justify-center pt-5 pb-6 border-2 border-gray-200 border-dashed rounded-lg hover:bg-gray-50 transition-colors">
                <svg class="w-8 h-8 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and
                  drop</p>
                <p class="text-xs text-gray-500">PDF, JPG, or PNG (MAX. 5MB)</p>
                <span id="file-name" class="mt-2 text-sm text-blue-600"></span>
              </div>
              <input type="file" name="invoice" id="invoiceFileInput" accept=".pdf,.jpg,.jpeg,.png" class="hidden" />
            </label>
          </div>
        </div>

        <div class="md:col-span-2 space-y-1">
          <label class="block text-sm font-medium text-gray-700">Description</label>
          <textarea name="description" rows="3"
            class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all resize-none"
            placeholder="Enter a detailed description (optional)"></textarea>
        </div>
      </div>

      <div class="mt-6 flex justify-end space-x-3">
        <button type="button"
          class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
          Cancel
        </button>
        <button type="submit"
          class="px-5 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all flex items-center">
          <i class="fa-solid fa-plus mr-2"></i>
          Submit Expense
        </button>
      </div>
    </form>

    <% 
      const totalSpent = expenses.reduce((sum, e) => sum + e.amount, 0); 
      const budgetUsed = Math.min((totalSpent / project.budget) * 100, 100);
      const overBudget = totalSpent > project.budget;
    %>

    <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm mb-6">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-lg font-semibold text-gray-800">Budget Usage</h2>
        <p class="text-sm font-medium <%= overBudget ? 'text-red-600' : 'text-gray-600' %>">
          $<%= totalSpent.toLocaleString('en-US', { minimumFractionDigits: 2 }) %>
          /
          $<%= project.budget.toLocaleString('en-US', { minimumFractionDigits: 2 }) %>
        </p>
      </div>

      <div class="w-full bg-gray-100 rounded-full h-4 overflow-hidden">
        <div class="h-4 transition-all duration-300 <%= overBudget ? 'bg-red-500' : 'bg-blue-500' %>"
          style="width: <%= (totalSpent / project.budget) * 100 %>%"></div>
      </div>

      <% if (overBudget) { %>
      <p class="text-sm mt-2 text-red-600 font-medium">
        🚨 Budget exceeded! Review expenses to stay on track.
      </p>
      <% } %>
    </div>

    <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-800">All Expenses</h2>
        <p class="text-sm text-gray-500">
          Total: $
          <%= expenses.reduce((sum, e) => sum + e.amount, 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
        </p>
      </div>

      <% if (expenses.length === 0) { %>
      <p class="text-gray-500 text-sm">No expenses recorded yet.</p>
      <% } else { %>
      <div class="overflow-x-auto rounded-xl shadow-sm border border-gray-200">
        <table class="min-w-full text-sm text-left text-gray-800">
          <thead class="bg-gray-100 text-gray-600 uppercase text-xs sticky top-0 z-10">
            <tr>
              <th class="px-6 py-3">Title</th>
              <th class="px-6 py-3">Amount</th>
              <th class="px-6 py-3">Category</th>
              <th class="px-6 py-3">Date</th>
              <th class="px-6 py-3">Added By</th>
              <th class="px-6 py-3">Invoice</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <% expenses.forEach((e, index) => { %>
            <tr class="hover:bg-gray-50 transition-all">
              <td class="px-6 py-4 font-medium"><%= e.title %></td>
              <td class="px-6 py-4 text-green-600 font-semibold">
                $<%= e.amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
              </td>
              <td class="px-6 py-4"><%= e.type %></td>
              <td class="px-6 py-4"><%= new Date(e.createdAt).toLocaleDateString('en-IN') %></td>
              <td class="px-6 py-4"><%= e.addedBy?.name || '—' %></td>
              <td class="px-6 py-4">
                <% if (e.invoicePath) { %>
                <div class="flex gap-2">
                  <button onclick="showInvoiceModal('<%= '/' + e.invoicePath.replace(/\\/g, '/') %>')"
                    class="text-blue-600 hover:underline text-xs">View</button>
                  <a href="<%= e.invoicePath.replace(/\\/g, '/') %>" download
                    class="text-green-600 hover:underline text-xs">Download</a>
                </div>
                <% } else { %>
                <span class="text-gray-400 text-xs">No Invoice</span>
                <% } %>
              </td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <% } %>
    </div>
  </div>
  <div id="invoiceModal"
    class="fixed inset-0 hidden items-center justify-center z-50 bg-black/50 backdrop-blur-sm transition-opacity duration-300 opacity-0">
    <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-6xl mx-4 max-h-[90vh] flex flex-col"
      onclick="event.stopPropagation()">
      <div
        class="sticky top-0 z-10 bg-white rounded-lg border-b border-gray-200 px-6 py-4 flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-900">Invoice Preview</h3>
        <button onclick="closeInvoiceModal()"
          class="text-gray-400 hover:text-gray-500 transition-colors p-1 rounded-full hover:bg-gray-100"
          aria-label="Close modal">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div id="invoiceContent" class="flex-1 overflow-auto p-6 flex justify-center items-center">
      </div>

      <div class="sticky bottom-0 bg-white border-t border-gray-200 px-6 py-3 flex justify-end space-x-3">
        <button onclick="closeInvoiceModal()"
          class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
          Close
        </button>
        <a id="downloadBtn" href="#" download
          class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors flex items-center">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
          </svg>
          Download
        </a>
      </div>
    </div>
  </div>

  <div id="budgetModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 relative">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">Update Project Budget</h3>

      <p class="text-sm text-yellow-600 mb-4">⚠️ Updating the budget will alert the client.</p>

      <form id="budgetForm" action="/projects/v/update/budget/<%= project._id %>" method="POST">
        <label class="block text-sm font-medium text-gray-700 mb-1">New Budget ($)</label>
        <input type="number" name="budget" step="0.01" required value="<%= project.budget %>"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
          placeholder="Enter new budget" />

        <div class="mt-6 flex justify-end space-x-2">
          <button type="button" onclick="closeBudgetModal()"
            class="px-4 py-2 text-sm text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">
            Cancel
          </button>
          <button type="button" onclick="openConfirmModal()"
            class="px-5 py-2.5 text-sm text-white bg-blue-600 rounded-lg hover:bg-blue-700">
            Continue
          </button>
        </div>
      </form>
    </div>
  </div>


  <div id="confirmModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-sm p-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">Are you sure?</h3>
      <p class="text-sm text-gray-600 mb-4">This will update the budget and notify the client.</p>
      <div class="flex justify-end space-x-2">
        <button onclick="closeConfirmModal()"
          class="px-4 py-2 text-sm text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">
          Cancel
        </button>
        <button type="button" onclick="document.getElementById('budgetForm').submit()"
          class="px-5 py-2.5 text-sm text-white bg-red-600 rounded-lg hover:bg-red-700">
          Confirm
        </button>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
</body>
<script>
  function showInvoiceModal(path) {
    const modal = document.getElementById('invoiceModal');
    const content = document.getElementById('invoiceContent');
    const downloadBtn = document.getElementById('downloadBtn');
    const ext = path.split('.').pop().toLowerCase();

    const sanitizedPath = '/' + path.replace(/\\/g, '/').replace(/^\/+/, '');
    downloadBtn.href = sanitizedPath;

    content.innerHTML = '<div class="animate-pulse">Loading...</div>';

    if (ext === 'pdf') {
      content.innerHTML = `
        <div class="w-full h-full">
          <embed 
            src="${sanitizedPath}" 
            type="application/pdf" 
            class="w-full min-h-[70vh] rounded-lg border border-gray-200"
          />
        </div>
      `;
    } else {
      content.innerHTML = `
        <div class="max-w-full max-h-[75vh] overflow-auto">
          <img 
            src="${sanitizedPath}" 
            alt="Invoice" 
            class="max-w-full max-h-full object-contain rounded-lg shadow-sm border border-gray-200 transition-all duration-300 cursor-zoom-in"
            onclick="this.style.transform = this.style.transform === 'scale(1.5)' ? 'scale(1)' : 'scale(1.5)'; this.classList.toggle('cursor-zoom-out')"
            onload="this.parentElement.scrollTo(this.width/2, this.height/2)"
          />
        </div>
      `;
    }

    modal.classList.remove('hidden');
    setTimeout(() => {
      modal.classList.add('flex');
      modal.classList.add('opacity-100');
    }, 10);

    modal.onclick = closeInvoiceModal;

    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') closeInvoiceModal();
    });
  }

  function closeInvoiceModal() {
    const modal = document.getElementById('invoiceModal');

    modal.classList.remove('opacity-100');
    setTimeout(() => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.getElementById('invoiceContent').innerHTML = '';

      modal.onclick = null;
      document.removeEventListener('keydown', closeInvoiceModal);
    }, 300);
  }



  document.getElementById('openBudgetPopup').onclick = function () {
    document.getElementById('budgetModal').classList.remove('hidden');
  };

  function closeBudgetModal() {
    document.getElementById('budgetModal').classList.add('hidden');
  }

  function openConfirmModal() {
    document.getElementById('budgetModal').classList.add('hidden');
    document.getElementById('confirmModal').classList.remove('hidden');
  }

  function closeConfirmModal() {
    document.getElementById('confirmModal').classList.add('hidden');
  }

  document.getElementById('invoiceFileInput').addEventListener('change', function () {
    const fileNameSpan = document.getElementById('file-name');
    const file = this.files[0];
    if (file) {
      fileNameSpan.textContent = file.name;
    } else {
      fileNameSpan.textContent = '';
    }
  });
</script>

</html>